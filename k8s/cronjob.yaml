apiVersion: batch/v1
kind: CronJob
metadata:
  name: tenangdb-backup
  namespace: tenangdb
  labels:
    app: tenangdb
spec:
  # Schedule: Daily at 2 AM
  schedule: "0 2 * * *"
  failedJobsHistoryLimit: 3        # This should be here
  successfulJobsHistoryLimit: 3    # This should be here
  # Timezone (optional, requires Kubernetes 1.25+)
  timeZone: "Asia/Jakarta"
  
  # Job configuration
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: tenangdb
            job-type: backup
        spec:
          serviceAccountName: tenangdb
          restartPolicy: OnFailure
          
          # Security context
          securityContext:
            runAsNonRoot: true
            runAsUser: 1001
            runAsGroup: 1001
            fsGroup: 1001
          
          containers:
          - name: tenangdb
            image: ghcr.io/abdullahainun/tenangdb:latest
            imagePullPolicy: Always
            
            # Command - use the main binary
            command: ["/tenangdb"]
            args: ["backup"]
            
            # Environment variables from secrets
            env:
            - name: MYSQL_USER
              valueFrom:
                secretKeyRef:
                  name: tenangdb-secrets
                  key: MYSQL_USER
            - name: MYSQL_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: tenangdb-secrets
                  key: MYSQL_PASSWORD
            # Optional: Cloud storage credentials
            - name: RCLONE_CONFIG
              valueFrom:
                secretKeyRef:
                  name: tenangdb-secrets
                  key: RCLONE_CONFIG
                  optional: true
            
            # Volume mounts
            volumeMounts:
            - name: config
              mountPath: /config.yaml
              subPath: config.yaml
              readOnly: true
            - name: backups
              mountPath: /backups
            - name: tracking
              mountPath: /tmp/tenangdb
            - name: logs
              mountPath: /var/log/tenangdb
            
            # Resource limits
            resources:
              requests:
                memory: "512Mi"
                cpu: "500m"
              limits:
                memory: "2Gi"
                cpu: "2000m"
            
            # Liveness and readiness probes (optional)
            # livenessProbe:
            #   exec:
            #     command:
            #     - /bin/sh
            #     - -c
            #     - "pgrep -f tenangdb || exit 1"
            #   initialDelaySeconds: 30
            #   periodSeconds: 60
          
          volumes:
          - name: config
            configMap:
              name: tenangdb-config
          - name: backups
            persistentVolumeClaim:
              claimName: pvc-tenangdb-backups
          - name: tracking
            persistentVolumeClaim:
              claimName: pvc-tenangdb-tracking
          - name: logs
            persistentVolumeClaim:
              claimName: pvc-tenangdb-logs
          
          # Optional: Node selector for dedicated backup nodes
          # nodeSelector:
          #   backup-node: "true"
          
          # Optional: Tolerations for dedicated backup nodes
          # tolerations:
          # - key: "backup-only"
          #   operator: "Equal"
          #   value: "true"
          #   effect: "NoSchedule"

---
# Optional: Manual backup job template
apiVersion: batch/v1
kind: Job
metadata:
  name: tenangdb-manual-backup
  namespace: tenangdb
  labels:
    app: tenangdb
    job-type: manual
spec:
  template:
    metadata:
      labels:
        app: tenangdb
        job-type: manual
    spec:
      serviceAccountName: tenangdb
      restartPolicy: Never
      
      securityContext:
        runAsNonRoot: true
        runAsUser: 1001
        runAsGroup: 1001
        fsGroup: 1001
      
      containers:
      - name: tenangdb
        image: ghcr.io/abdullahainun/tenangdb:latest
        imagePullPolicy: Always
        
        command: ["/tenangdb"]
        args: ["backup", "--force"]  # Force backup even if frequency check fails
        
        env:
        - name: MYSQL_USER
          valueFrom:
            secretKeyRef:
              name: tenangdb-secrets
              key: MYSQL_USER
        - name: MYSQL_PASSWORD
          valueFrom:
            secretKeyRef:
              name: tenangdb-secrets
              key: MYSQL_PASSWORD
        - name: RCLONE_CONFIG
          valueFrom:
            secretKeyRef:
              name: tenangdb-secrets
              key: RCLONE_CONFIG
              optional: true
        
        volumeMounts:
        - name: config
          mountPath: /config.yaml
          subPath: config.yaml
          readOnly: true
        - name: backups
          mountPath: /backups
        - name: tracking
          mountPath: /tmp/tenangdb
        - name: logs
          mountPath: /var/log/tenangdb
        
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "2000m"
      
      volumes:
      - name: config
        configMap:
          name: tenangdb-config
      - name: backups
        persistentVolumeClaim:
          claimName: pvc-tenangdb-backups
      - name: tracking
        persistentVolumeClaim:
          claimName: pvc-tenangdb-tracking
      - name: logs
        persistentVolumeClaim:
          claimName: pvc-tenangdb-logs